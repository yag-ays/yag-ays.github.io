<!DOCTYPE html>
<html lang="ja">

<head>
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="yag_ays&#39;s blog">


    <meta property="twitter:site" content="@yag_ays">

<meta property="og:site_name" content="Out-of-the-box" />
<meta property="og:locale" content="nn_NO" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yag-ays.github.io/project/elasticsearch-similarity-search/" />
<meta property="og:title" content="Elasticsearchで分散表現を使った類似文書検索" />
<meta property="twitter:title" content="Elasticsearchで分散表現を使った類似文書検索">

    <meta property="og:image" content="https://yag-ays.github.io/img/banner.png">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:image" content="https://yag-ays.github.io/img/banner.png">

<meta property="og:description" content="">
<meta property="twitter:description" content="">

<title>


     Elasticsearchで分散表現を使った類似文書検索 - Out-of-the-box 

</title>
<link rel="canonical" href="https://yag-ays.github.io/project/elasticsearch-similarity-search/">


<style media="screen">
  @font-face {
  font-family: 'Nexa Bold';
  src: url('https://yag-ays.github.io/fonts/Nexa Bold.otf');
}

html, body, div, span, applet, object, iframe,
h1, h2, h3, h4, h5, h6, p, blockquote, pre,
a, abbr, acronym, address, big, cite, code,
del, dfn, em, img, ins, kbd, q, s, samp,
small, strike, strong, sub, tt, var,
b, u, i, center,
dl, dt, dd, ol, ul, li,
fieldset, form, label, legend,
table, caption, tbody, tfoot, thead, tr, th, td,
article, aside, canvas, details, embed,
figure, figcaption, footer, header, hgroup,
menu, nav, output, ruby, section, summary,
time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
  font-size: 100%;
  font: inherit;
  vertical-align: baseline;
}
/* HTML5 display-role reset for older browsers */
article, aside, details, figcaption, figure,
footer, header, hgroup, menu, nav, section, div.column {
  display: block;
}
body {
  line-height: 1;
}
ol, ul {
  list-style: none;
}
blockquote, q {
  quotes: none;
}
blockquote:before, blockquote:after,
q:before, q:after {
  content: '';
  content: none;
}
table {
  border-collapse: collapse;
  border-spacing: 0;
}

*,
*:before,
*:after {
  box-sizing: border-box;
}
a,
a:visited,
a:focus,
a:active {
  text-decoration: none;
}
html {
  height: 100%;
  font-size: 16px;
}
body {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-flex-direction: column;
  -moz-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  -webkit-justify-content: flex-start;
  -moz-justify-content: flex-start;
  -ms-justify-content: flex-start;
  justify-content: flex-start;
  width: 100%;
  min-height: 100%;
  font-weight: 400;
  font-family: 'Helvetica Neue', 'Arial', sans-serif;
  color: #111111;
  line-height: 1.6;
  text-rendering: optimizeLegibility !important;
}
.icon {
  text-rendering: geometricPrecision !important;
}
section {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-justify-content: center;
  -moz-justify-content: center;
  -ms-justify-content: center;
  justify-content: center;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  width: 100%;
}
div.column {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-justify-content: center;
  -moz-justify-content: center;
  -ms-justify-content: center;
  justify-content: center;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  width: 100%;
}
.container {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  width: 100%;
}
div.header .container {
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  -webkit-justify-content: center;
  -moz-justify-content: center;
  -ms-justify-content: center;
  justify-content: center;
}
div.header .content {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-flex-direction: column;
  -moz-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
}
div.header .container .logo {
  max-width: 100px;
  margin-left: -2em;
}
div.header .name {
  padding-top: 20px;
  font-size: 28px;
  font-family: 'Nexa Bold', 'Helvetica Neue', 'Arial', sans-serif;
  letter-spacing: -0.005rem;
  
  text-transform: uppercase;
  
  -moz-osx-font-smoothing: grayscale;
  -webkit-font-smoothing: antialiased;
  font-smoothing: antialiased;
  color: #333333;
}
div.header nav {
  margin-bottom: 16px;
}
div.header nav ul {
  list-style: none;
  text-align: center;
  display: -webkit-inline-flex;
  display: -moz-inline-flex;
  display: -ms-inline-flexbox;
  display: -ms-inline-flex;
  display: inline-flex;
}
div.header nav ul li {
  margin-left: 6px;
  margin-right: 6px;
}
div.header nav ul li:first-child {
  margin-left: 0;
}
div.header nav ul li:last-child {
  margin-right: 0;
}
div.header nav ul a {
  color: #555555;
  font-weight: 400;
  font-size: 14px;
  text-transform: uppercase;
  font-family: 'Helvetica Neue', 'Arial', sans-serif;
  -webkit-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -moz-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -ms-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -o-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
}
div.header nav ul a:hover {
  color: #111111;
}
div.footer .container {
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  -webkit-justify-content: center;
  -moz-justify-content: center;
  -ms-justify-content: center;
  justify-content: center;
  flex-direction: column-reverse;
  width: 100%;
  text-align: center;
}
div.footer .container a {
  font-size: 14px;
  margin-left: 6px;
  margin-right: 6px;
  opacity: 0.6;
  -webkit-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -moz-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -ms-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -o-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
}
div.footer .container a:first-child {
  margin-left: 0;
}
div.footer .container a:last-child {
  margin-right: 0;
}
div.footer .container a:hover {
  opacity: 0.8;
}
div.footer .container a .icon {
  width: 16px;
  height: 16px;
}
div.footer .container .copyright {
  flex-grow: 0.5;
  text-align: start;
}
div.footer .container .icons {
  flex-grow: 0.5;
  text-align: end;
}
div.main .container {
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  -webkit-justify-content: flex-start;
  -moz-justify-content: flex-start;
  -ms-justify-content: flex-start;
  justify-content: flex-start;
}
div.main .content {
  color: #111111;
  font-size: 16px;
}
div.main .content .title-container {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-justify-content: space-between;
  -moz-justify-content: space-between;
  -ms-justify-content: space-between;
  justify-content: space-between;
}
div.main .content .posts {
  margin-bottom: 4em;
}
div.main .content .page-heading {
  font-size: 22px;
  font-weight: 700;
  font-family: 'Helvetica Neue', 'Arial', sans-serif;
  letter-spacing: -0.005rem;
  text-transform: uppercase;
  -moz-osx-font-smoothing: grayscale;
  -webkit-font-smoothing: antialiased;
  font-smoothing: antialiased;
  color: #333333;
  margin-bottom: 16px;
}
div.main .content .front-matter .page-heading {
  margin-bottom: 0;
}
div.main .content .front-matter .meta {
  font-size: 14px;
  color: #666666;
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  margin-bottom: 32px;
}
div.main .content .front-matter .date,
div.main .content .front-matter .author,
div.main .content .front-matter .tags,
div.main .content .front-matter .word-count,
div.main .content .front-matter .middot:before {
  display: none;
}
div.main .content .front-matter .middot:before {
  font-size: 6px;
  margin: 0 6px;
  vertical-align: middle;
  content: "•";
}
div.main .content .front-matter .tags ul {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-flex-direction: row;
  -moz-flex-direction: row;
  -ms-flex-direction: row;
  flex-direction: row;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
}
div.main .content .front-matter .tags ul li {
  -webkit-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -moz-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -ms-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -o-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
}
div.main .content .front-matter .tags ul li:hover {
  opacity: 0.7;
}
div.main .content .front-matter .tags ul li a {
  color: #666666;
}
div.main .container.f04 {
  -webkit-justify-content: center;
  -moz-justify-content: center;
  -ms-justify-content: center;
  justify-content: center;
}
div.main .container.f04 .content {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-flex-direction: column;
  -moz-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
}
div.main .container.f04 .content .num {
  margin: 30px 0px 30px 0;
  font-weight: 400;
  font-family: 'Helvetica Neue', 'Arial', sans-serif;
  font-size: 50px;
}
div.main .container.f04 .content .detail {
  margin-bottom: 40px;
}
div.main .container .content .groupby {
  margin-top: 1em;
  padding-left: 0.5em;
}
div.main .container .content .post-item {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  display: list-item;
  list-style: disc inside;
}
div.main .container .content .post-item .meta {
  font-size: 14px;
  color: #666666;
  display: none;
  min-width: 100px;
}
div.main .container .content .see-more {
  font-style: italic;
  float: right;
  font-size: 0.9em;
  margin-top: 2em;
  color: #313537;
}
div.main .container .content .see-more:hover {
  color: #666;
}
section {
  padding: 0 16px;
}
div.column {
  padding: 0 16px;
}
div.header {
  padding-top: 10px;
}
div.header-home {
  padding-top: 36px;
}
div.main {
  padding-top: 32px;
}
div.main .container .content .post-item .meta {
    display: block;
}
div.main .container .content .post-item {
    display: flex;
    list-style: none;
}
a {
  color: #428bca;
  -webkit-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -moz-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -ms-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -o-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
}
a:hover {
  color: #2a6496;
}
img {
  max-width: 100%;
}
div.main .content {
    width: 100%;
}
div.main .content .markdown {
  font-size: 1.0em;
  line-height: 1.75em;
  color: #313537;
  font-family: serif;
  font-weight: 300;
}
div.main .content .markdown h1,
div.main .content .markdown h2,
div.main .content .markdown h3,
div.main .content .markdown h4,
div.main .content .markdown h5,
div.main .content .markdown h6 {
  font-size: 22px;
  font-family: 'Helvetica Neue', 'Arial', sans-serif;
  letter-spacing: -0.005rem;
  font-weight: 700;
  -moz-osx-font-smoothing: grayscale;
  -webkit-font-smoothing: antialiased;
  font-smoothing: antialiased;
  color: #333333;
  text-transform: none;
  margin-top: 1.75rem;
}
div.main .content .markdown h1 {
  font-size: 1.75rem;
  margin-bottom: 2rem;
}
div.main .content .markdown h2 {
  font-size: 1.5rem;
  margin-bottom: 1.5rem;
}
div.main .content .markdown h3 {
  font-size: 1em;
  margin-bottom: 1rem;
}
div.main .content .markdown h4,
div.main .content .markdown h5,
div.main .content .markdown h6 {
  font-size: 1rem;
  margin-bottom: 1rem;
  letter-spacing: none;
}
div.main .content .markdown code,
div.main .content .markdown pre {
  font-family: 'Menlo', monospace;
  font-size: 0.98rem;
  background-color: #f7f7f7;
}
div.main .content .markdown code {
  /* enclosed by single backtick (`) */
  padding: .15em .5em;
  border-radius: 2px;
}
div.main .content .markdown pre {
  /* Hugo specific: consider using the 'highlight' shortcode */
  display: block;
  margin-top: 1rem;
  margin-bottom: 2rem;
  padding: 1rem;
  line-height: 1.5em;
  white-space: pre;
  word-break: break-all;
  word-wrap: break-word;
}
div.main .content .markdown pre code {
  /* enclosed by 4 backticks (````) */
  padding: 0;
  font-size: 0.9rem;
}
div.main .content .markdown a code {
  color: #428bca !important;
}
div.main .content .markdown a code:hover {
  text-decoration: underline;
}
div.main .content .markdown p {
  
  text-align: justify;
  
  margin-top: 0;
  margin-bottom: 1em;
}
div.main .content .markdown ul,
div.main .content .markdown ol,
div.main .content .markdown dl {
  margin-top: 1rem;
  margin-bottom: 2rem;
}
div.main .content .markdown dt {
  font-weight: bold;
}
div.main .content .markdown dd {
  margin-bottom: .5rem;
}
div.main .content .markdown ul {
  list-style-type: disc;
  list-style-position: outside;
  margin-bottom: 1.25rem;
}
div.main .content .markdown ol {
  list-style-type: decimal;
  margin-bottom: 1.25rem;
}
div.main .content .markdown li {
  margin-left: 2em;
}
div.main .content .markdown em {
  font-style: italic;
}
div.main .content .markdown strong {
  font-weight: 700;
}
div.main .content .markdown hr {
  position: relative;
  margin: 1.75rem 0;
  border: 0;
  border-top: 1px solid #808080;
  border-top: 1px solid #999999;
}
div.main .content .markdown abbr {
  font-size: 0.85rem;
  font-weight: bold;
  color: #666666;
  text-transform: uppercase;
}
div.main .content .markdown abbr[title] {
  cursor: help;
  border-bottom: 1px dotted #808080;
}
div.main .content .markdown blockquote {
  padding: .5rem 1rem;
  margin: .8rem 0;
  color: #7a7a7a;
  border-left: .25rem solid #e5e5e5;
}
div.main .content .markdown blockquote p:last-child {
  margin-bottom: 0;
}
div.main .content .markdown figure {
  width: 100%;
  background: #fff;
  margin-bottom: 1em;
}
div.main .content .markdown figure img {
  width: 100%;
  height: auto;
  max-width: 80%;
  display: block;
  position: static;
  margin: auto;
}
div.main .content .markdown table {
  margin-bottom: 1rem;
  width: 100%;
  border: 1px solid #e5e5e5;
  border-collapse: collapse;
}
div.main .content .markdown td,
div.main .content .markdown th {
  padding: .25rem .5rem;
  border: 1px solid #e5e5e5;
}
div.main .content .markdown tbody tr:nth-child(odd) td,
div.main .content .markdown tbody tr:nth-child(odd) th {
  background-color: #f7f7f7;
}
div.main .content .markdown .footnotes ol {
  list-style-type: decimal;
  margin-left: 16px;
}
div.main .content .markdown .footnotes li {
  list-style-type: unset;
}
div.main .content .markdown .footnote-ref {
  font-size: 0.7em;
}
div.main .content .navigation {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-flex-direction: column;
  -moz-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  padding: 2em;
}
div.main .content .navigation div {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-flex-direction: row;
  -moz-flex-direction: row;
  -ms-flex-direction: row;
  flex-direction: row;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  margin-top: 1em;
}
div.main .content .navigation .icon {
  width: 16px;
  height: 16px;
}
div.main .content .navigation a {
  width: 250px;
  margin: 0 1em;
  text-align: center;
  font-style: italic;
  color: #313537;
}
div.main .content .share, div.main .content .share div {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-flex-direction: row;
  -moz-flex-direction: row;
  -ms-flex-direction: row;
  flex-direction: row;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  justify-content: center;
}
div.main .content .share {
  background-color: rgba(152, 152, 152, 0.07);
  padding: 1em 0;
}
div.main .content .share a {
  margin: 0 6px;
}
kbd {
  padding: 0.1em 0.6em;
  border: 1px solid #ccc;
  font-size: 11px;
  font-family: Arial,Helvetica,sans-serif;
  background-color: #f7f7f7;
  color: #333;
  -moz-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;
  -webkit-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;
  box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;
  -moz-border-radius: 3px;
  -webkit-border-radius: 3px;
  border-radius: 3px;
  display: inline-block;
  margin: 0 0.1em;
  text-shadow: 0 1px 0 #fff;
  line-height: 1.4;
  white-space: nowrap;
}

/* Fonts */


.wf-raleway-n4-active body,
.wf-raleway-n4-active div.header nav ul a,
.wf-raleway-n7-active div.main .content .page-heading,
.wf-raleway-n2-active div.main .container.f04 .content .num,
.wf-raleway-n7-active div.main .content .markdown h1,
.wf-raleway-n7-active div.main .content .markdown h2,
.wf-raleway-n7-active div.main .content .markdown h3,
.wf-raleway-n7-active div.main .content .markdown h4,
.wf-raleway-n7-active div.main .content .markdown h5,
.wf-raleway-n7-active div.main .content .markdown h6 {
      font-family: 'Raleway';
}

.wf-merriweather-n3-active div.main .content .markdown {
      font-family: 'Merriweather';
}

.wf-ubuntu-mono-n4-active div.main .content .markdown code,
.wf-ubuntu-mono-n4-active div.main .content .markdown pre {
      font-family: 'Ubuntu Mono';
}



div.page-heading .container .date {
  font-size: 15px;
  margin: 0 0 0 auto;
}

</style>
<style media="(min-width: 600px)">
  body {
-webkit-justify-content: center;
-moz-justify-content: center;
-ms-justify-content: center;
justify-content: center;
}
.non-narrow.zero-top-spacing {
padding-top: 0 !important;
}
section {
padding: 0 16px;
margin-left: 100px;
margin-right: 100px;
max-width: 750px;
}
div.column {
padding: 0 16px;
max-width: 750px;
}
div.header {
background-color: transparent;
}
div.header .container {
-webkit-justify-content: flex-start;
-moz-justify-content: flex-start;
-ms-justify-content: flex-start;
justify-content: flex-start;
}
div.header .container .logo {
margin: 0;
}
div.header-home .container .logo {
max-width: 180px;
margin-left: 20px;
}
div.header-home .name-home {
padding-top: 30px;
font-size: 40px;
}
div.header-home nav ul a {
font-size: 18px;
}
div.header .content {
-webkit-align-items: flex-start;
-moz-align-items: flex-start;
-ms-align-items: flex-start;
align-items: flex-start;
}
div.header .name {
color: #333333;
}
div.header nav {
font-size: 14px;
margin-bottom: 0;
}
div.header nav ul {
text-align: left;
}
div.header nav ul a {
color: #666666;
}
div.header nav ul a:hover {
color: #333333;
}
div.footer {
background-color: transparent;
}
div.footer .container {
flex-direction: row;
}
div.footer .container a {
margin-left: 3px;
margin-right: 3px;
color: #666666;
}
div.footer .container a:hover {
color: #333333;
}
div.footer .container a .icon {
font-size: 18px;
}
div.footer .container a .icon.larger {
font-size: 20px;
}
div.main .content .front-matter .date,
div.main .content .front-matter .author,
div.main .content .front-matter .tags,
div.main .content .front-matter .word-count,
div.main .content .front-matter .middot:before {
display: initial;
}
div.main .container.f04 {
-webkit-justify-content: flex-start;
-moz-justify-content: flex-start;
-ms-justify-content: flex-start;
justify-content: flex-start;
}
div.main .container.f04 .content {
-webkit-align-items: flex-start;
-moz-align-items: flex-start;
-ms-align-items: flex-start;
align-items: flex-start;
}
div.main .container.f04 .content .num {
margin: 0 0 10px 0;
font-size: 32px;
}
div.main .container.f04 .content .detail {
margin-bottom: 30px;
}
.container {
padding: 0 30px;
}
div.header {
padding-top: 60px;
padding-bottom: 60px;
}
div.footer {
padding-top: 30px;
padding-bottom: 60px;
}
div.main {
padding-top: 0;
}
div.main .container .content .post-item {
display: flex;
list-style: none;
padding-left: 1.5em;
}
div.main .container .content .post-item .meta {
display: block;
}
div.main.post {
padding-top: 60px;
padding-bottom: 60px;
}
div.main .content .markdown blockquote {
padding-right: 5rem;
padding-left: 1.25rem;
}
div.main .content .navigation {
-webkit-flex-direction: row;
-moz-flex-direction: row;
-ms-flex-direction: row;
flex-direction: row;
}
div.main .content .navigation div {
margin-top: 0em;
}

</style>
<style media="(min-width: 769px)">
  div.main .content .markdown figure {
width: 110%;
margin-left: -4%;
}
div.main .content .markdown img {
max-width: 110%;
width: 110%;
margin-left: -4%;
}
div.main .content .markdown pre {
width: 110%;
margin-left: -4%;
}

</style>

<noscript>
  <link href="https://fonts.googleapis.com/css?family=Raleway:400,600,700" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Merriweather:300,300i,700,700i" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700" rel="stylesheet">
</noscript>


  <style type="text/css" media="screen">
    .hljs{display:block;background:white;padding:0.5em;color:#333333;overflow-x:auto}.hljs-comment,.hljs-meta{color:#969896}.hljs-string,.hljs-variable,.hljs-template-variable,.hljs-strong,.hljs-emphasis,.hljs-quote{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#a71d5d}.hljs-literal,.hljs-symbol,.hljs-bullet,.hljs-attribute{color:#0086b3}.hljs-section,.hljs-name{color:#63a35c}.hljs-tag{color:#333333}.hljs-title,.hljs-attr,.hljs-selector-id,.hljs-selector-class,.hljs-selector-attr,.hljs-selector-pseudo{color:#795da3}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}
  </style>











<link rel="shortcut icon"

    href="https://yag-ays.github.io/img/favicon.png"

>




</head>


<body>


<div class="header column">

    <div class="container">
        
        <a href="https://yag-ays.github.io/"><img class="logo" src="https://yag-ays.github.io/img/logo.png" alt="logo"></a>
        
        <div class="content">
            <a href="https://yag-ays.github.io/"><div class="name"><h1>Out-of-the-box</h1></div></a>
            <nav>
                <ul>
                    
                    
                        
                            
                            <li><a href="https://yag-ays.github.io/project">project</a></li>
                            
                        
                    
                    
                        
                    
                </ul>
            </nav>
        </div>
    </div>
</div>



<div class="main column">
    <div class="container">
        <div class="content">
            <div class="page-heading">

    Elasticsearchで分散表現を使った類似文書検索
    <div class="container">
      <div class="date">
        2019-09-02
      </div>
    </div>

</div>

            <div class="markdown">
                
    

<p><img src="https://yag-ays.github.io/img/elasticsearch-similarity-search_header.png" alt="https://www.pexels.com/photo/aerial-view-of-house-village-2255938/" /></p>

<h2 id="概要">概要</h2>

<p>Elasticseachに分散表現のベクトルに対する類似文書検索が実装されたということで、以下のElasticのブログ記事を参考に類似文書検索を試してみました。</p>

<p><a href="https://www.elastic.co/jp/blog/text-similarity-search-with-vectors-in-elasticsearch">Text similarity search in Elasticsearch using vector fields | Elastic Blog</a></p>

<h3 id="tl-dr">tl;dr</h3>

<ul>
<li>Elasticsearchでベクトルの類似文書検索機能が実装された</li>
<li>Wikipedia日本語記事全116万エントリーに対して検索時間は約0.8秒</li>
<li>Elasticsearchの既存の検索機能と組み合わせることが可能</li>
</ul>

<hr />

<h2 id="方法">方法</h2>

<h3 id="1-elasticsearchの設定">1. Elasticsearchの設定</h3>

<p>Dockerを使ってElasticsearchを立ち上げます。Elasticsearchでの高次元ベクトルのフィールドタイプ対応はバージョン7.0、検索機能はバージョン7.3からサポートされているため、<code>docker.elastic.co</code>で提供されているバージョン7.3.1を利用しました。以下のように<code>docker-compose.yaml</code>を定義して<code>docker-compose up</code>で起動します。</p>

<pre><code class="language-yaml"># docker-compose.yaml
version: '3.3'
services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.3.1
    ports:
      - &quot;9200:9200&quot;
    volumes:
      - es-data:/usr/share/elasticsearch/data
    tty: true
    environment:
      discovery.type: single-node
volumes:
  es-data:
    driver: local
</code></pre>

<p>立ち上がった後は<code>curl http://127.0.0.1:9200/_cat/health</code>で結果が帰ってくればOKです。</p>

<h3 id="2-wikipediaの本文を文ベクトルに変換してelasticsearchに投入する">2. Wikipediaの本文を文ベクトルに変換してElasticsearchに投入する</h3>

<p>今回はある程度現実的な状況を再現するため、データセットはWikipediaの日本語のすべてのエントリーを使用しました。Wikipediaのエントリーに含まれるテキストをダンプデータから抽出し、分散表現を計算するとともにElasticsearchにインポートします。文書の分散表現の計算には、SWEMのaverage-poolingを利用します。手法の詳細は<a href="https://yag-ays.github.io/project/swem/">こちらの記事</a>を参考ください。</p>

<p>まず <code>index.json</code>でインデックスのマッピングタイプを指定します。文書ベクトルには<code>&quot;type&quot;: &quot;dense_vector&quot;</code>、次元数を<code>&quot;dims&quot;: 200</code>で指定します。</p>

<pre><code class="language-json"># index.json
&quot;properties&quot;: {
  &quot;title&quot;: {
    &quot;type&quot;: &quot;text&quot;
  },
  &quot;text&quot;: {
    &quot;type&quot;: &quot;text&quot;
  },
  &quot;text_vector&quot;: {
    &quot;type&quot;: &quot;dense_vector&quot;,
    &quot;dims&quot;: 200
  }
}
</code></pre>

<p>あとはElasticsearchに文書およびその文書の分散表現を登録していくだけです。注意点として、PythonのElasticsearchパッケージを利用する場合は、<code>dense_vector</code>にはnumpyのndarrayではなくPythonのリスト型に変換したものを渡す必要があります。</p>

<h3 id="3-ベクトルのフィールドを対象に検索">3. ベクトルのフィールドを対象に検索</h3>

<p>これでやっと準備は整いました。あとは類似文書検索のクエリを投げるだけですが、当然ながらElasticsearchにはクエリから分散表現を作成する機能はありません。そのため検索の際には、クエリを受け付けた後にPython側で文の分散表現に変換し、そのベクトルをElasticsearchに渡す形で実現します。</p>

<pre><code class="language-py"># query string to sentence embedding vector
query_vector = swem.average_pooling(query).tolist()

script_query = {
    &quot;script_score&quot;: {
        &quot;query&quot;: {&quot;match_all&quot;: {}},
        &quot;script&quot;: {
            &quot;source&quot;: &quot;cosineSimilarity(params.query_vector, doc['text_vector']) + 1.0&quot;,
            &quot;params&quot;: {&quot;query_vector&quot;: query_vector}
        }
    }
}

response = client.search(
    index=INDEX_NAME,
    body={
        &quot;size&quot;: SEARCH_SIZE,
        &quot;query&quot;: script_query,
        &quot;_source&quot;: {&quot;includes&quot;: [&quot;title&quot;, &quot;text&quot;]}
    }
)
</code></pre>

<p>ここでは検索スコアの計算に<code>cosineSimilarity</code>関数を利用しています。なお、コサイン類似度自体に<code>+1.0</code>しているのは、Elasticsearchが負のスコアをサポートしていないからとのこと。</p>

<h2 id="コード">コード</h2>

<ul>
<li><a href="https://github.com/yagays/wikipedia_es_similarity">yagays/wikipedia_es_similarity</a></li>
</ul>

<h2 id="実験条件">実験条件</h2>

<ul>
<li>データ

<ul>
<li>Wikipediaテキスト: Cirrus Searchダンプデータ<code>jawiki-20190826-cirrussearch-content.json.gz</code>の<code>text</code>を利用</li>
<li>文書数: 1,165,654件</li>
</ul></li>
<li>実行環境

<ul>
<li>Ubuntu 16.04.6 / 8 CPU / 32GB Memory</li>
<li>docker-compose: version 1.24.1</li>
<li>elasticsearch:7.3.1</li>
</ul></li>
</ul>

<hr />

<h2 id="実験-1-全件対象に類似文書検索">実験 1: 全件対象に類似文書検索</h2>

<p>まずはシンプルに、すべてのWikipediaのエントリーを対象に類似文書検索を行います。</p>

<h3 id="検索結果">検索結果</h3>

<p>クエリ：</p>

<blockquote>
<p>バーレーンの首都マナマ(マナーマとも)で現在開催されているユネスコ(国際連合教育科学文化機関)の第42回世界遺産委員会は日本の推薦していた「長崎と天草地方の潜伏キリシタン関連遺産」 (長崎県、熊本県)を30日、世界遺産に登録することを決定した。文化庁が同日発表した。日本国内の文化財の世界遺産登録は昨年に登録された福岡県の「『神宿る島』宗像・沖ノ島と関連遺産群」に次いで18件目。2013年の「富士山-信仰の対象と芸術の源泉」の文化遺産登録から6年連続となった。</p>

<p><a href="https://ja.wikinews.org/wiki/%E6%BD%9C%E4%BC%8F%E3%82%AD%E3%83%AA%E3%82%B7%E3%82%BF%E3%83%B3%E9%96%A2%E9%80%A3%E9%81%BA%E7%94%A3%E3%80%81%E4%B8%96%E7%95%8C%E9%81%BA%E7%94%A3%E7%99%BB%E9%8C%B2">潜伏キリシタン関連遺産、世界遺産登録 - ウィキニュース</a></p>
</blockquote>

<p>結果：</p>

<table>
<thead>
<tr>
<th align="left">順位</th>
<th align="left">記事タイトル 　　　　　　　　　　　　　</th>
<th align="left">記事本文(冒頭)</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">1</td>
<td align="left">日本遺産</td>
<td align="left">日本遺産（にほんいさん、Japan Heritage）は、文化庁が認定した、地域の歴史的魅力や特色を通じて日本の文化・伝統を語るストーリーである。</td>
</tr>

<tr>
<td align="left">2</td>
<td align="left">武家の古都・鎌倉</td>
<td align="left">「武家の古都・鎌倉」（ぶけのこと・かまくら、英語: Kamakura, Home of the SAMURAI）とは、神奈川県鎌倉市・横浜市・逗子市に残る歴史的建造物群を対象とする世界遺産暫定リスト掲載物件である。</td>
</tr>

<tr>
<td align="left">3</td>
<td align="left">「神宿る島」宗像・沖ノ島と関連遺産群</td>
<td align="left">「神宿る島」宗像・沖ノ島と関連遺産群（「かみやどるしま」むなかた・おきのしまとかんれんいさんぐん）は、ユネスコの世界遺産リスト登録物件で、日本の世界遺産の中では21番目に登録された。</td>
</tr>

<tr>
<td align="left">4</td>
<td align="left">世界遺産委員会</td>
<td align="left">世界遺産委員会（せかいいさんいいんかい）は、世界遺産に関して話し合うための国際連合教育科学文化機関の委員会。</td>
</tr>

<tr>
<td align="left">5</td>
<td align="left">百舌鳥・古市古墳群</td>
<td align="left">百舌鳥・古市古墳群 -古代日本の墳墓群-（もず・ふるいちこふんぐん -こだいにほんのふんぼぐん-）は、大阪府堺市、羽曳野市、藤井寺市にある45件49基の古墳群の総称。</td>
</tr>

<tr>
<td align="left">6</td>
<td align="left">近世高岡の文化遺産群</td>
<td align="left">近世高岡の文化遺産群（きんせいたかおかのぶんかいさんぐん）とは、富山県高岡市にある、同県と同市がユネスコの世界遺産への登録を目指している文化財の総称。</td>
</tr>

<tr>
<td align="left">7</td>
<td align="left">明治日本の産業革命遺産 製鉄・製鋼、造船、石炭産業</td>
<td align="left">明治日本の産業革命遺産 製鉄・製鋼、造船、石炭産業（めいじにほんのさんぎょうかくめいいさん せいてつ・せいこう、ぞうせん、せきたんさんぎょう）は、2015年の第39回世界遺産委員会でUNESCOの世界遺産リストに登録された日本の世界遺産の一つであり、山口・福岡・佐賀・長崎・熊本・鹿児島・岩手・静岡の8県に点在する。</td>
</tr>

<tr>
<td align="left">8</td>
<td align="left">紀伊山地の霊場と参詣道</td>
<td align="left">紀伊山地の霊場と参詣道（きいさんちのれいじょうとさんけいみち）は、和歌山県・奈良県・三重県にまたがる3つの霊場（吉野・大峰、熊野三山、高野山）と参詣道（熊野参詣道、大峯奥駈道、高野山町石道）を登録対象とする世界遺産（文化遺産）。</td>
</tr>

<tr>
<td align="left">9</td>
<td align="left">静岡県富士山世界遺産センター</td>
<td align="left">静岡県富士山世界遺産センター（しずおかけんふじさんせかいいさんセンター）は、静岡県富士宮市にある博物館。</td>
</tr>

<tr>
<td align="left">10</td>
<td align="left">ドレスデン・エルベ渓谷</td>
<td align="left">ドレスデン・エルベ渓谷（ドレスデン・エルベけいこく、ドイツ語: Dresdner Elbtal）とは、かつてユネスコの世界遺産に登録されていた物件である。</td>
</tr>
</tbody>
</table>

<p>検索結果のWikipediaのエントリー10件を、類似度が高い順に表示しています。</p>

<p>ざっと見た限りでは世界遺産や日本の文化遺産に関わる記事が上位に来ており、きちんと分散表現をもとに類似文書検索ができていると思います。この類似度算出の精度に関しては文の分散表現を獲得するロジックに依存する部分なので、今回のElasticsearchの機能とはあまり関係ありません。</p>

<p>ちなみに、1位の「日本遺産」に違和感を感じますが、エントリー内に日本国内の世界遺産が列挙されていることから結果的に類似度が高くなったのではないかと考えられます。</p>

<h3 id="検索時間">検索時間</h3>

<p>文の分散表現を計算する部分とElasticsearchに検索クエリを投げて結果が返ってくる2つを計測しました。それぞれの結果は以下のようになりました。</p>

<ul>
<li>embedding time: <code>0.84 ms</code></li>
<li>search time: <code>879.49 ms</code></li>
</ul>

<p>全体の実行時間としては1.0秒かからないくらいで、その殆どはElasticsearchの類似度検索にかかっているようです。ここでは<code>match_all</code>というクエリすべての文書を対象にコサイン類似度を計算しているため、さすがに100万件を超えると少し処理が重いようです。ただ今回の検証ではElasticsearch自体のチューニングはおこなっていないため、計算機のリソースや設定次第でもう少し早くなる可能性はあると思います。</p>

<hr />

<h2 id="実験-2-条件を指定して類似文書検索">実験 2: 条件を指定して類似文書検索</h2>

<p>Elasticsearchは豊富な検索機能があり、それを使うことで分散表現による検索以上の絞り込みが可能になります。この実験では試しに、「〜川」というWikipediaタイトルのエントリーに限定して、その類似文書を検索してみます。</p>

<pre><code>&quot;script_score&quot;: {
    &quot;query&quot;: {&quot;wildcard&quot;: {
        &quot;title&quot;: {
            &quot;value&quot;: &quot;*川&quot;
        }
    }},
</code></pre>

<p>クエリ：</p>

<blockquote>
<p>レヒ川（独: Lech）は、オーストリアとドイツを流れる河川。ドナウ川の支流で、長さは264km。水源はオーストリア・フォアアールベルク州のフォルマリン川で、北北東に流れてドイツとの国境で高さ12mのレヒ滝（ドイツ語版）を形成し、その後狭い渓谷となる。ドイツ国内ではフュッセン、アウクスブルクなどを通り、ドナウ川に合流する。</p>

<p><a href="https://ja.wikipedia.org/wiki/%E3%83%AC%E3%83%92%E5%B7%9D">レヒ川 - Wikipedia</a></p>
</blockquote>

<h3 id="検索結果-1">検索結果</h3>

<table>
<thead>
<tr>
<th align="left">順位</th>
<th align="left">記事タイトル 　　　　　　　　　　　　　</th>
<th align="left">記事本文(冒頭)</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">1</td>
<td align="left">レヒ川</td>
<td align="left">レヒ川（独: Lech）は、オーストリアとドイツを流れる河川。</td>
</tr>

<tr>
<td align="left">2</td>
<td align="left">イン川</td>
<td align="left">「イン川（インがわ、英語: Inn river）は、スイス・オーストリア・ドイツの3ヶ国にわたって流れる川で、ドナウ川の支川のひとつ。</td>
</tr>

<tr>
<td align="left">3</td>
<td align="left">オーデル川</td>
<td align="left">オーデル川（独: Oder, 波: Odra）は、中央ヨーロッパを流れる河川である。</td>
</tr>

<tr>
<td align="left">4</td>
<td align="left">イルメナウ川</td>
<td align="left">イルメナウ川（独: Ilmenau）は、ドイツのニーダーザクセン州を流れる川で、エルベ川の支流である。</td>
</tr>

<tr>
<td align="left">5</td>
<td align="left">ライネ川</td>
<td align="left">ライネ川（ライネがわ、ドイツ語: Leine）は、ドイツのテューリンゲン州やニーダーザクセン州などを流れる長さ281kmの河川で、アラー川の支流である。</td>
</tr>

<tr>
<td align="left">6</td>
<td align="left">ナイセ川</td>
<td align="left">ナイセ川（ドイツ語：Neiße）はオーデル川の支流。チェコ北部に源流を発し、第二次世界大戦後に設定されたドイツとポーランドの国境であるオーデル・ナイセ線の一部を成す。</td>
</tr>

<tr>
<td align="left">7</td>
<td align="left">ザーレ川</td>
<td align="left">ザーレ川（ザーレがわ、Saale）は、ザクセンのザーレ川（Sächsische Saale）、あるいはテューリンゲンのザーレ川（Thüringische Saale）とも呼ばれ、バイエルン州、テューリンゲン州、ザクセン＝アンハルト州を流れる全長413kmの河川で、モルダウ川に次いでエルベ川第2の支流である。</td>
</tr>

<tr>
<td align="left">8</td>
<td align="left">フレンキシェ・レーツァト川</td>
<td align="left">フレンキシェ・レーツァト川（Fränkische Rezat、フランケンのレーツァト川）は、全長65km。レドニッツ川左岸、すなわち西側の源流で、ドイツ、バイエルン州ミッテルフランケンを流れる川。</td>
</tr>

<tr>
<td align="left">9</td>
<td align="left">アディジェ川</td>
<td align="left">アディジェ川（イタリア語: Adige）は、イタリア北部を流れアドリア海に注ぐ、イタリアで2番目に長い川である。</td>
</tr>

<tr>
<td align="left">10</td>
<td align="left">ムール川</td>
<td align="left">ムール川（Mura）は、ヨーロッパ中央部、主にオーストリアを流れる河川。ドナウ川支流のドラーヴァ川の支流である。</td>
</tr>
</tbody>
</table>

<p>検索クエリで指定したとおり「〜川」に関する記事のみを抽出できていることがわかります。また、検索クエリに対して地理的にヨーロッパ近辺の川が類似記事として上位にきており、文章中に登場する地名などの意味的な近さを捉えて類似文書を検索できていそうです。</p>

<h3 id="検索時間-1">検索時間</h3>

<p>では検索時間はどうでしょうか？全件を対象にした検索では0.8秒ほどかかっていましたが、条件を指定した状態での検索では約0.04秒と高速に動作しており、絞り込みの効果が発揮されていると言えます。</p>

<ul>
<li>embedding time: <code>0.71 ms</code></li>
<li>search time: <code>40.95 ms</code></li>
</ul>

<h2 id="まとめ">まとめ</h2>

<p>今回はElasticsearchを使って分散表現を使った類似文書検索を試してみました。実行速度には課題が残るものの、分散表現のベクトルを特定のフィールドに入れるだけという手軽さはとても良いと思います。</p>

<p>こうしたベクトル表現を使った類似アイテムの検索では、現在のところ近似最近傍探索のパッケージを利用して独自に検索APIを実装することが多いです。そうしたスクラッチでの開発には専門的な知識が必要であり、また高速化や多重化など運用上のコストが大きくなるため、Elasticsearchという広く使われている検索エンジンをそのまま利用できるというのは、開発と運用ともに多くのメリットがあるのではないかと思います。</p>

<h2 id="参考">参考</h2>

<ul>
<li><a href="https://www.elastic.co/jp/blog/text-similarity-search-with-vectors-in-elasticsearch">Text similarity search in Elasticsearch using vector fields | Elastic Blog</a></li>
</ul>


<div style="text-align: right">
  <a href="http://b.hatena.ne.jp/entry/https://yag-ays.github.io/project/elasticsearch-similarity-search/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png"
      alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
  <script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a>
  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>


            </div>
        </div>
    </div>
</div>



<div class="footer column">
    <div class="container">

        

        <div class="copyright">

        
            
                <a href="https://creativecommons.org/licenses/by-sa/4.0/">Copyright © 2018 yag_ays</a>
            
        

        </div>
        <div class="icons">

        

        

        

        
            <a href="https://github.com/yagays" target="_blank">
                <img class="icon" src="https://yag-ays.github.io/img/github.svg" alt="github" />
            </a>
        

        
            <a href="https://twitter.com/yag_ays" target="_blank">
                <img class="icon" src="https://yag-ays.github.io/img/twitter.svg" alt="twitter" />
            </a>
        

        
            <a href="https://www.linkedin.com/in/yukiokuda" target="_blank">
                <img class="icon" src="https://yag-ays.github.io/img/linkedin.svg" alt="linkedin" />
            </a>
        

        

        
            <a href="https://yag-ays.github.io/index.xml">
                <img class="icon" src="https://yag-ays.github.io/img/rss.svg" alt="rss" />
            </a>
        

        </div>
    </div>
</div>


<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
<script>
  WebFont.load({
    google: {
      families: ['Raleway:400,600,700', 'Merriweather:300,300i,700,700i', 'Ubuntu+Mono:400,700']
    }
  });
</script>



  <script src="https://yag-ays.github.io/js/highlight.min.js" defer></script>
  









<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-17620484-8', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<script>
  window.onload = function() {
    
      hljs.initHighlighting();
    
    
    
  };
</script>




</body>
</html>

